name: ü§ñ Processar Fromtis com Comprovantes

on:
  # Permite execu√ß√£o manual via interface do GitHub
  workflow_dispatch:
    inputs:
      dias_comprovantes:
        description: 'Dias retroativos para buscar comprovantes'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '3'
          - '7'
          - '15'
          - '30'
      modo_debug:
        description: 'Ativar modo debug (logs detalhados)'
        required: false
        default: false
        type: boolean
  
  # Agendamento autom√°tico (di√°rio √†s 9h UTC = 6h Bras√≠lia)
  schedule:
    - cron: '0 9 * * 1-5'  # Segunda a Sexta, 9h UTC

jobs:
  processar-fromtis:
    name: Processar Fromtis
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
      # ============================================================
      # ETAPA 1: PREPARA√á√ÉO DO AMBIENTE
      # ============================================================
      - name: üìÇ Checkout do c√≥digo
        uses: actions/checkout@v4
      
      - name: üêç Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Instalar depend√™ncias Python
        run: |
          python -m pip install --upgrade pip
          pip install requests unicodedata2
          echo "‚úÖ Depend√™ncias Python instaladas"
      
      - name: üü¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üì¶ Instalar depend√™ncias Node
        run: |
          npm install
          echo "‚úÖ Depend√™ncias Node instaladas"
      
      # ============================================================
      # ETAPA 2: CONFIGURAR CREDENCIAIS
      # ============================================================
      - name: üîê Configurar credenciais a partir do secret √∫nico
        run: |
          echo "Extraindo credenciais do secret KANASTRA_CREDENTIALS..."
          
          # Parsear o JSON do secret
          $credentials = $env:KANASTRA_CREDENTIALS | ConvertFrom-Json
          
          # Criar diret√≥rio tempor√°rio para certificados
          $certDir = "$env:TEMP\santander_certs"
          New-Item -ItemType Directory -Force -Path $certDir | Out-Null
          
          # Salvar certificados Santander
          $credentials.santander.cert_pem | Out-File -FilePath "$certDir\santander_cert.pem" -Encoding utf8 -NoNewline
          $credentials.santander.key_pem | Out-File -FilePath "$certDir\santander_key.pem" -Encoding utf8 -NoNewline
          
          # Salvar fundos Santander como JSON
          $credentials.santander.fundos | ConvertTo-Json -Depth 10 | Out-File -FilePath "santander_fundos_temp.json" -Encoding utf8
          
          # Definir vari√°veis de ambiente
          echo "SANTANDER_CERT_PATH=$certDir\santander_cert.pem" >> $env:GITHUB_ENV
          echo "SANTANDER_KEY_PATH=$certDir\santander_key.pem" >> $env:GITHUB_ENV
          echo "FROMTIS_USERNAME=$($credentials.fromtis.username)" >> $env:GITHUB_ENV
          echo "FROMTIS_PASSWORD=$($credentials.fromtis.password)" >> $env:GITHUB_ENV
          
          echo "‚úÖ Credenciais configuradas com sucesso"
          echo "  - Certificados Santander: OK"
          echo "  - Fundos Santander: OK"
          echo "  - Credenciais Fromtis: OK"
        env:
          KANASTRA_CREDENTIALS: ${{ secrets.KANASTRA_CREDENTIALS }}
      
      # ============================================================
      # ETAPA 3: GERAR MAPEAMENTO DE FUNDOS
      # ============================================================
      - name: üó∫Ô∏è Gerar mapeamento Fromtis ‚Üí CNPJ
        run: |
          echo "Gerando mapeamento de fundos..."
          python exportar_mapeamento_fundos.py
          
          if (Test-Path "mapeamento_fundos_fromtis.json") {
            $content = Get-Content "mapeamento_fundos_fromtis.json" -Raw | ConvertFrom-Json
            $count = ($content | Get-Member -MemberType NoteProperty).Count
            echo "‚úÖ Mapeamento gerado com $count fundos"
          } else {
            echo "‚ùå Erro: arquivo de mapeamento n√£o foi gerado"
            exit 1
          }
      
      # ============================================================
      # ETAPA 4: BUSCAR COMPROVANTES SANTANDER
      # ============================================================
      - name: üí∞ Buscar comprovantes Santander
        run: |
          $dias = "${{ inputs.dias_comprovantes }}"
          if ([string]::IsNullOrEmpty($dias)) { $dias = "1" }
          
          echo "Buscando comprovantes dos √∫ltimos $dias dias..."
          python listar_comprovantes_santander.py --dias $dias
          
          # Verificar se arquivo foi gerado
          $arquivos = Get-ChildItem -Filter "listagem_comprovantes_*.json" | Sort-Object LastWriteTime -Descending
          if ($arquivos.Count -eq 0) {
            echo "‚ùå Erro: nenhum arquivo de comprovantes gerado"
            exit 1
          }
          
          $arquivo = $arquivos[0].Name
          $content = Get-Content $arquivo -Raw | ConvertFrom-Json
          $count = $content.Count
          
          echo "‚úÖ $count comprovantes encontrados"
          echo "üìÑ Arquivo: $arquivo"
          
          # Salvar nome do arquivo para pr√≥ximos steps
          echo "COMPROVANTES_FILE=$arquivo" >> $env:GITHUB_ENV
        env:
          # Credenciais j√° configuradas nas vari√°veis de ambiente
          SANTANDER_CERT_PATH: ${{ env.SANTANDER_CERT_PATH }}
          SANTANDER_KEY_PATH: ${{ env.SANTANDER_KEY_PATH }}
      
      # ============================================================
      # ETAPA 5: COMPILAR TYPESCRIPT
      # ============================================================
      - name: üî® Compilar TypeScript
        run: |
          echo "Compilando puppeteer_com_comprovantes_v2.ts..."
          npx tsc puppeteer_com_comprovantes_v2.ts --skipLibCheck
          
          if (Test-Path "puppeteer_com_comprovantes_v2.js") {
            echo "‚úÖ TypeScript compilado com sucesso"
          } else {
            echo "‚ùå Erro na compila√ß√£o do TypeScript"
            exit 1
          }
      
      # ============================================================
      # ETAPA 6: EXECUTAR ROB√î PUPPETEER NO FROMTIS
      # ============================================================
      - name: ü§ñ Executar rob√¥ Fromtis
        run: |
          echo "üöÄ Iniciando processamento do Fromtis..."
          echo ""
          echo "üìä Configura√ß√µes:"
          echo "  - Modo debug: ${{ inputs.modo_debug }}"
          echo "  - Comprovantes: $env:COMPROVANTES_FILE"
          echo "  - Mapeamento: mapeamento_fundos_fromtis.json"
          echo "  - Usu√°rio Fromtis: $env:FROMTIS_USERNAME"
          echo ""
          
          # Executar Node.js com o rob√¥
          node puppeteer_com_comprovantes_v2.js
          
          echo ""
          echo "‚úÖ Processamento conclu√≠do"
        env:
          DEBUG_MODE: ${{ inputs.modo_debug }}
          FROMTIS_USERNAME: ${{ env.FROMTIS_USERNAME }}
          FROMTIS_PASSWORD: ${{ env.FROMTIS_PASSWORD }}
      
      # ============================================================
      # ETAPA 7: COLETAR RESULTADOS
      # ============================================================
      - name: üìä Gerar relat√≥rio de execu√ß√£o
        if: always()
        run: |
          echo "üìã Gerando relat√≥rio de execu√ß√£o..."
          
          # Criar arquivo de resumo
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          $relatorio = @"
          ========================================
          RELAT√ìRIO DE EXECU√á√ÉO - FROMTIS
          ========================================
          Data/Hora: $timestamp
          Dias buscados: ${{ inputs.dias_comprovantes }}
          Modo Debug: ${{ inputs.modo_debug }}
          
          ARQUIVOS GERADOS:
          "@
          
          # Listar arquivos gerados
          Get-ChildItem -Filter "*.json" | ForEach-Object {
            $size = [math]::Round($_.Length / 1KB, 2)
            $relatorio += "`n  - $($_.Name) ($size KB)"
          }
          
          # Verificar logs de execu√ß√£o
          $logs = Get-ChildItem -Filter "execution_log_*.txt" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($logs) {
            $relatorio += "`n`n√öLTIMO LOG:"
            $relatorio += "`n" + (Get-Content $logs.FullName -Raw | Select-Object -Last 50)
          }
          
          $relatorio | Out-File "relatorio_execucao.txt" -Encoding utf8
          
          echo "‚úÖ Relat√≥rio gerado"
          echo ""
          echo $relatorio
      
      # ============================================================
      # ETAPA 8: FAZER UPLOAD DOS RESULTADOS
      # ============================================================
      - name: üì§ Upload dos resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fromtis-resultados-${{ github.run_number }}
          path: |
            execution_log_*.txt
            listagem_comprovantes_*.json
            mapeamento_fundos_fromtis.json
            relatorio_execucao.txt
          retention-days: 30
          if-no-files-found: warn
      
      # ============================================================
      # ETAPA 9: NOTIFICA√á√ÉO DE SUCESSO/FALHA
      # ============================================================
      - name: ‚úÖ Notificar sucesso
        if: success()
        run: |
          echo "::notice::üéâ Processamento do Fromtis conclu√≠do com sucesso!"
      
      - name: ‚ùå Notificar falha
        if: failure()
        run: |
          echo "::error::üí• Erro no processamento do Fromtis. Verifique os logs."
      
      # ============================================================
      # ETAPA 10: LIMPEZA
      # ============================================================
      - name: üßπ Limpar certificados tempor√°rios
        if: always()
        run: |
          $certDir = "$env:TEMP\santander_certs"
          if (Test-Path $certDir) {
            Remove-Item -Recurse -Force $certDir
            echo "‚úÖ Certificados tempor√°rios removidos"
          }
